<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Leaflet GeoJSON 強調表示</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="./leaflet.css" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    #map {
      width: 100vw;
      height: 100vh;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="./leaflet.js"></script>
  <script>
    const map = L.map('map').setView([34.6507, 135.3856], 17);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let currentVisibleLayer = null;

    fetch('./facilities/all-points.tsv')
      .then(response => response.text())
      .then(text => {
        const lines = text.trim().split('\n');
        const data = lines.slice(1).map(line => {
          const cols = line.split('\t');
          return {
            id: cols[0],
            lng: parseFloat(cols[1]),
            lat: parseFloat(cols[2])
          };
        });

        data.forEach(point => {
          fetch(`./facilities/${point.id}.geojson`)
            .then(response => response.json())
            .then(geojson => {
              const layer = L.geoJSON(geojson, {
                style: {
                  color: 'blue',
                  weight: 2,
		  fill: true,
                  fillColor: 'blue',
                  fillOpacity: 0.0,
                  opacity: 0.0
                },
                onEachFeature: function (feature, layer) {
                  const center = layer.getBounds().getCenter();

                  const makeVisible = () => {
                    layer.setStyle({ fillOpacity: 0.3, opacity: 1.0 });
                  };

                  const makeInvisible = () => {
                    layer.setStyle({ fillOpacity: 0.0, opacity: 0.0 });
                  };

                  const popup = L.popup()
                    .setLatLng(center)
                    .setContent(point.id);

                  layer.on('mouseover', () => makeVisible());

                  layer.on('mouseout', () => {
                    if (!map.hasLayer(popup)) makeInvisible();
                  });

                  layer.on('click', () => {
                    if (currentVisibleLayer && currentVisibleLayer !== layer) {
                      currentVisibleLayer.setStyle({ fillOpacity: 0.0, opacity: 0.0 });
                    }
                    makeVisible();
                    popup.openOn(map);
                    currentVisibleLayer = layer;
                  });

                  map.on('popupclose', () => {
                    makeInvisible();
                    currentVisibleLayer = null;
                  });
                }
              });

              layer.addTo(map);
            })
            .catch(err => console.error(`Error loading GeoJSON for ${point.id}:`, err));
        });
      });
  </script>
</body>
</html>
