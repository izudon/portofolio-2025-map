<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Leaflet GeoJSON 強調表示</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="./leaflet/leaflet.css" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    #map {
      width: 100vw;
      height: 100vh;
    }
    .leaflet-popup-content-wrapper {
      max-width: 85vmin;
      max-height: 45vh;
      overflow: visible; /* ← スクロールさせない */
      box-sizing: border-box;
    }
    .leaflet-popup-content {
      font-size: 6vmin;
      line-height: 1.3;
      color: #333;
      overflow: auto;
    }
    .greeting-box {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 90vmin;
      height: 90vmin;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 8px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 6vmin;
    }
    .greeting-bos h2 {
      font-size: 14vmin;
    }

    .greeting-box button {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="./leaflet/leaflet.js"></script>
  <div id="greeting" class="greeting-box">
    <h2>Day 101</h2>
    <p>2025-07-22</p>
    <div>
      <h3>海外パビリオン</h3>
    </div>
    <button onclick="document.getElementById('greeting').style.display='none'">
      Close
    </button>
  </div>

  <script>

    class Facility {
      static APPEAR = {
        opacity: 0.5,
        fillOpacity: 0.2
      };
    
      static DISAPPEAR = {
        opacity: 0.0,
        fillOpacity: 0.0
      };
    
      static POLYGON_STYLE;
    
      static {
        Facility.POLYGON_STYLE = {
          weight: 3,
          color: "#3388ff",
          fillColor: "#3388ff",
          ...Facility.DISAPPEAR
        };
      }
    
      static POPUP_STYLE = {
        maxWidth: 300,
        maxHeight: 200
      };
    
      static map = null; // ← 外部から代入される共通マップ
    
      constructor(id) {
        this.id = id;
      }
    
      static create(id, geojson, popupHtml) {
        const facility = new Facility(id);
      
        const feature = geojson.features?.[0];
        const geometry = feature?.geometry;
      
        if (!geometry) throw new Error(`No geometry in geojson for id: ${id}`);
      
        facility.popup = L.popup(Facility.POPUP_STYLE)
          .setContent(popupHtml);
      
        const addEvents = layer => {
          layer.on("mouseover", () => facility.appear());
          layer.on("mouseout", () => facility.disappear());
          layer.on("click", () => facility.raise());
          layer.on("popupclose", () => facility.lower());
        };
      
        if (geometry.type === "Polygon" || geometry.type === "MultiPolygon") {
          facility.polygon = L.geoJSON(feature, {
            style: Facility.POLYGON_STYLE,
            onEachFeature: (_, layer) => addEvents(layer)
          });
          facility.center = facility.polygon.getBounds().getCenter();
          facility.polygon.addTo(Facility.map);
        } else if (geometry.type === "Point") {
          const coords = geometry.coordinates;
          facility.marker = L.geoJSON(feature, {
            onEachFeature: (_, layer) => addEvents(layer)
          });
          facility.center = L.latLng(coords[1], coords[0]);
          facility.marker.addTo(Facility.map);
        } else {
          throw new Error(`Unsupported geometry type: ${geometry.type}`);
        }
      
        facility.popup.setLatLng(facility.center);
        return facility;
      }
    
      appear() {
        this.polygon?.setStyle(Facility.APPEAR);
      }
    
      disappear() {
        this.polygon?.setStyle(Facility.DISAPPEAR);
      }
    
      raise() {
        this.popup?.openOn(Facility.map);
        Facility.map.panTo(this.center, { duration: 0.5 });
      }
    
      lower() {
        this.popup?.close();
      }
    }


    const map = L.map('map', {
      center: [34.649952, 135.383606], // 静けさの森の中央点
      maxZoom: 18,
      zoom: 17.5,
      zoomSnap: 0.5,
      zoomDelta: 0.5
    });
    
    Facility.map = map; // ← クラス変数に map を登録
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    Promise.all([
      fetch('./data/geojsons.json').then(res => res.json()),
      fetch('./data/popups.json'  ).then(res => res.json())
    ]).then(([g, p]) => {
      return Object.fromEntries(
        Object.entries(g).map(([id, _]) => [id, Facility.create(id, g[id], p[id])])
      );
    }).then(data => {
      const params = new URLSearchParams(window.location.search);
      const id = params.get("facility");
      if (id !== null) {
        data[id].raise();
      }
    }).catch(error => {
      console.error('読み込みエラー:', error);
    });
    
  </script>
</body>
</html>
